<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.muziuniv_be_notuser.app.staff.approval.ApprovalMapper">

    <!-- 신청서 목록 조회 (논리적 복직신청 대응) -->
    <select id="selectApplications">
        SELECT
        a.app_id,
        a.user_id,
        a.status,
        a.reason,
        a.created_at,
        sc.schedule_type,
        sm.year,
        sm.semester
        FROM application a
        JOIN schedule sc ON a.schedule_id = sc.schedule_id
        JOIN semester sm ON sc.semester_id = sm.semester_id
        WHERE sm.year = #{year}
        <if test="semester != null">
            AND sm.semester = #{semester}
        </if>

        <if test="scheduleType != null and scheduleType != ''">
            AND sc.schedule_type = #{scheduleType}
        </if>
        ORDER BY a.created_at DESC
    </select>

    <!-- 신청 상태 변경 -->
    <update id="updateApplicationStatus">
        UPDATE application
        SET status = #{status}
        WHERE app_id = #{appId}
    </update>

    <!-- 강의 승인용 -->
    <select id="findCoursesByStatus">
        SELECT
        c.user_id,
        c.course_id,
        c.course_code,
        c.title,
        c.classroom,
        c.type,
        c.grade,
        c.time,
        c.credit,
        c.max_std
        FROM course c
        WHERE c.semester_id = #{sid}
        AND c.status = '처리중'
        <if test="type != null and type != ''">
            AND c.type = #{type}
        </if>
        <if test="keyword != null and keyword != ''">
            AND c.title LIKE CONCAT('%', #{keyword}, '%')
        </if>
    </select>

</mapper>
