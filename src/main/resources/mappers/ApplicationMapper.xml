<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.muziuniv_be_notuser.app.shared.application.ApplicationMapper">

    <select id="isScheduleOpenNow">
        SELECT CASE WHEN NOW() BETWEEN sc.start_datetime AND sc.end_datetime THEN 1 ELSE 0 END
        FROM schedule sc
        WHERE sc.schedule_id = #{scheduleId}
    </select>

    <select id="existsActiveApplication">
        SELECT COUNT(*)
        FROM application a
        JOIN schedule s ON a.schedule_id = s.schedule_id
        WHERE a.user_id = #{userId}
        AND s.semester_id = #{semesterId}
        AND s.schedule_type = #{scheduleType}
        AND a.status = '처리중'
    </select>

    <select id="findSemesterIdByScheduleId">
        SELECT semester_id FROM schedule WHERE schedule_id = #{scheduleId}
    </select>

    <select id="findScheduleTypeByScheduleId">
        SELECT schedule_type FROM schedule WHERE schedule_id = #{scheduleId}
    </select>

    <insert id="insertApplication">
        INSERT INTO application
        (user_id, schedule_id, schedule_type, status, reason, created_at)
        VALUES
        (#{userId}, #{scheduleId},
        (SELECT schedule_type FROM schedule WHERE schedule_id = #{scheduleId}),
        '처리중', #{reason}, NOW())
    </insert>

    <select id="selectMyApplications">
        SELECT
        a.app_id AS appId,
        a.status,
        a.reason,
        a.created_at AS submittedAt,
        sc.schedule_type AS scheduleType,
        sc.start_datetime AS scheduleStart,
        sc.end_datetime AS scheduleEnd,
        sem.year AS year,
        sem.semester AS semester
        FROM application a
        JOIN schedule sc ON sc.schedule_id = a.schedule_id
        JOIN semester sem ON sem.semester_id = sc.semester_id
        WHERE a.user_id = #{userId}
        ORDER BY a.created_at DESC
    </select>

    <delete id="deleteApplication">
        DELETE FROM application
        WHERE app_id = #{appId} AND user_id = #{userId}
    </delete>

    <!-- 특정 일정(schedule_id)에 연결된 신청(application) 개수 조회 -->
    <select id="countByScheduleId">
        SELECT COUNT(*)
        FROM application
        WHERE schedule_id = #{scheduleId}
    </select>
</mapper>
